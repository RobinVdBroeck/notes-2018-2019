version: 2

jobs:
  deploy:
    docker:
      # specify the version you desire here
      - image: circleci/ruby:2.5
    working_directory: ~/repo

    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "Gemfile.lock" }}

      - run:
          name: install dependencies
          command: bundle install --jobs=4 --retry=3 --path vendor/bundle

      - save_cache:
          paths:
            - ./vendor/bundle
          key: v1-dependencies-{{ checksum "Gemfile.lock" }}

      - run:
          name: Build asciidoc files to html5
          command: bundle exec asciidoctor -b html5 -D build ai.adoc recht.adoc

      - deploy:
          name: Deploy Release to GitHub
          command: |
            git checkout -f gh-pages
            ls | grep -v .git | grep -v build | grep -v .circleci | xargs rm -rf
            mv -v build/* .
            git config --global user.email circleci@circleci
            git config --global user.name Circleci
            git add .
            git commit -m "CircleCI docs build"
            # Quiet so we don't show the key in the logs
            git push -q https://${DOCS_GITHUB_TOKEN}@github.com/RobinVdBroeck/notes-2018-2019.git gh-pages

workflows:
  version: 2
  default:
    jobs:
      - deploy:
          filters:
            branches:
              ignore: gh-pages
